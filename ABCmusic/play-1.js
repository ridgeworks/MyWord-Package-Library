// abc2svg - ABC to SVG translator
// @source: https://github.com/moinejf/abc2svg.git
// Copyright (C) 2014-2017 Jean-Francois Moine - LGPL3+
// play-1.js for abc2svg-1.15.3 (2017-12-02)
function AbcPlay(conf){var audio=new ToAudio,audio5=new Audio5(conf);return{clear:audio.clear,add:audio.add,play:audio5.play,stop:audio5.stop,get_sft:audio5.get_sft,get_sfu:audio5.get_sfu,get_vol:audio5.get_vol,set_sft:audio5.set_sft,set_sfu:audio5.set_sfu,set_speed:audio5.set_speed,set_vol:audio5.set_vol,set_follow:audio5.set_follow}}function ToAudio(){var BAR=0,CLEF=1,GRACE=4,KEY=5,NOTE=8,REST=10,STAVES=12,TEMPO=14,BASE_LEN=1536,scale=new Uint8Array([0,2,4,5,7,9,11]),a_e,p_time,abc_time,play_factor;ToAudio.prototype.clear=function(){var a_pe=a_e;a_e=null;return a_pe};ToAudio.prototype.add=function(start,voice_tb){var bmap=new Float32Array(7),map,vmap=[],i,n,dt,d,v,top_v,rep_st_s,rep_en_s,rep_nx_s,rep_st_transp,rep_st_map,rep_st_fac,transp,s=start;function set_voices(){var v,s;transp=new Int8Array(voice_tb.length);for(v=0;v<voice_tb.length;v++){s=voice_tb[v].clef;transp[v]=!s.clef_octave||s.clef_oct_transp?0:s.clef_octave;if(!vmap[v])vmap[v]=new Float32Array(70);map=vmap[v];voice_tb[v].key.v=v;key_map(voice_tb[v].key)}}function bar_map(v){for(var j=0;j<10;j++)for(var i=0;i<7;i++)vmap[v][j*7+i]=bmap[i]}function key_map(s){if(s.k_bagpipe){bmap=[100-13.7,-2,2,100-15.6,-31.2,0,3.9];for(var i=0;i<7;i++)bmap[i]=(bmap[i]+150.6)/100}else{for(var i=0;i<7;i++)bmap[i]=0;switch(s.k_sf){case 7:bmap[6]=1;case 6:bmap[2]=1;case 5:bmap[5]=1;case 4:bmap[1]=1;case 3:bmap[4]=1;case 2:bmap[0]=1;case 1:bmap[3]=1;break;case-7:bmap[3]=-1;case-6:bmap[0]=-1;case-5:bmap[4]=-1;case-4:bmap[1]=-1;case-3:bmap[5]=-1;case-2:bmap[2]=-1;case-1:bmap[6]=-1;break}}bar_map(s.v)}function pit2mid(s,i){var n,oct,note=s.notes[i];p=note.pit+19,a=note.acc;if(transp[s.v])p+=transp[s.v];if(a){if(a==3)a=0;else if(note.micro_n)a=(a<0?-note.micro_n:note.micro_n)/note.micro_d*2;map[p]=a}return(p/7|0)*12+scale[p%7]+map[p]}function do_tie(s,note,d){var n,end_time=s.time+s.dur,pit=note.pit,p=pit+19,a=note.acc;if(transp[s.v])p+=transp[s.v];for(s=s.next;;s=s.next){if(!s)return d;if(s==rep_en_s){var v=s.v;s=rep_nx_s.ts_next;while(s&&s.v!=v)s=s.ts_next;if(!s)return d;end_time=s.time}if(s.time!=end_time)return d;if(s.type==NOTE)break}n=s.notes.length;for(i=0;i<n;i++){note=s.notes[i];if(note.pit==pit){d+=s.dur/play_factor;note.ti2=true;return note.ti1?do_tie(s,note,d):d}}return d}function gen_grace(s){var g,i,n,t,d,next=s.next;if(s.sappo){d=BASE_LEN/16}else if((!next||next.type!=NOTE)&&s.prev&&s.prev.type==NOTE){d=s.prev.dur/2}else{after=true;if(!next.dots)d=next.dur/2;else if(next.dots==1)d=next.dur/3;else d=next.dur*2/7;next.time+=d;next.dur-=d}n=0;for(g=s.extra;g;g=g.next)if(g.type==NOTE)n++;d/=n*play_factor;t=p_time;for(g=s.extra;g;g=g.next){if(g.type!=NOTE)continue;gen_notes(g,t,d);t+=d}}function gen_notes(s,t,d){for(var i=0;i<=s.nhd;i++){var note=s.notes[i];if(note.ti2)continue;a_e.push([s.istart,t,s.p_v.instr,pit2mid(s,i),note.ti1?do_tie(s,note,d):d])}}set_voices();if(!a_e){a_e=[];abc_time=rep_st_t=p_time=0;play_factor=BASE_LEN/4*120/60}else if(s.time<abc_time){abc_time=rep_st_t=s.time}while(s){if(s.type==TEMPO&&s.tempo){d=0;n=s.tempo_notes.length;for(i=0;i<n;i++)d+=s.tempo_notes[i];play_factor=d*s.tempo/60}dt=s.time-abc_time;if(dt>0){p_time+=dt/play_factor;abc_time=s.time}if(s==rep_en_s){s=rep_nx_s;abc_time=s.time}map=vmap[s.v];switch(s.type){case BAR:if(s.v!=top_v)break;if(s.bar_type[0]==":"){s.bar_type="|";rep_nx_s=s;if(!rep_en_s)rep_en_s=s;if(rep_st_s){s=rep_st_s;for(v=0;v<voice_tb.length;v++){for(i=0;i<70;i++)vmap[v][i]=rep_st_map[v][i];transp[v]=rep_st_transp[v]}play_factor=rep_st_fac}else{s=start;set_voices();for(v=0;v<voice_tb.length;v++)bar_map(v)}abc_time=s.time;break}if(!s.invis){for(v=0;v<voice_tb.length;v++)bar_map(v)}if(s.bar_type[s.bar_type.length-1]==":"){rep_st_s=s;rep_en_s=null;for(v=0;v<voice_tb.length;v++){if(!rep_st_map)rep_st_map=[];if(!rep_st_map[v])rep_st_map[v]=new Float32Array(70);for(i=0;i<70;i++)rep_st_map[v][i]=vmap[v][i];if(!rep_st_transp)rep_st_transp=[];rep_st_transp[v]=transp[v]}rep_st_fac=play_factor;break}else if(s.text&&s.text[0]=="1"){rep_en_s=s}break;case CLEF:transp[s.v]=!s.clef_octave||s.clef_oct_transp?0:s.clef_octave;break;case GRACE:if(s.time==0&&abc_time==0){dt=0;if(s.sappo)dt=BASE_LEN/16;else if(!s.next||s.next.type!=NOTE)dt=d/2;abc_time-=dt}gen_grace(s);break;case KEY:key_map(s);break;case REST:case NOTE:d=s.dur;if(s.next&&s.next.type==GRACE){dt=0;if(s.next.sappo)dt=BASE_LEN/16;else if(!s.next.next||s.next.next.type!=NOTE)dt=d/2;s.next.time-=dt;d-=dt}if(s.type==NOTE)gen_notes(s,p_time,d/play_factor);break;case STAVES:top_v=s.sy.top_voice;break}s=s.ts_next}}}if(typeof module=="object"&&typeof exports=="object")exports.ToAudio=ToAudio;function Audio5(i_conf){var instr_tb=["acoustic_grand_piano","bright_acoustic_piano","electric_grand_piano","honkytonk_piano","electric_piano_1","electric_piano_2","harpsichord","clavinet","celesta","glockenspiel","music_box","vibraphone","marimba","xylophone","tubular_bells","dulcimer","drawbar_organ","percussive_organ","rock_organ","church_organ","reed_organ","accordion","harmonica","tango_accordion","acoustic_guitar_nylon","acoustic_guitar_steel","electric_guitar_jazz","electric_guitar_clean","electric_guitar_muted","overdriven_guitar","distortion_guitar","guitar_harmonics","acoustic_bass","electric_bass_finger","electric_bass_pick","fretless_bass","slap_bass_1","slap_bass_2","synth_bass_1","synth_bass_2","violin","viola","cello","contrabass","tremolo_strings","pizzicato_strings","orchestral_harp","timpani","string_ensemble_1","string_ensemble_2","synth_strings_1","synth_strings_2","choir_aahs","voice_oohs","synth_choir","orchestra_hit","trumpet","trombone","tuba","muted_trumpet","french_horn","brass_section","synth_brass_1","synth_brass_2","soprano_sax","alto_sax","tenor_sax","baritone_sax","oboe","english_horn","bassoon","clarinet","piccolo","flute","recorder","pan_flute","blown_bottle","shakuhachi","whistle","ocarina","lead_1_square","lead_2_sawtooth","lead_3_calliope","lead_4_chiff","lead_5_charang","lead_6_voice","lead_7_fifths","lead_8_bass__lead","pad_1_new_age","pad_2_warm","pad_3_polysynth","pad_4_choir","pad_5_bowed","pad_6_metallic","pad_7_halo","pad_8_sweep","fx_1_rain","fx_2_soundtrack","fx_3_crystal","fx_4_atmosphere","fx_5_brightness","fx_6_goblins","fx_7_echoes","fx_8_scifi","sitar","banjo","shamisen","koto","kalimba","bagpipe","fiddle","shanai","tinkle_bell","agogo","steel_drums","woodblock","taiko_drum","melodic_tom","synth_drum","reverse_cymbal","guitar_fret_noise","breath_noise","seashore","bird_tweet","telephone_ring","helicopter","applause","gunshot"],loop=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),nn=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"],no="0012345678";var conf=i_conf,onend=function(){},onnote=function(){},ac,gain,gain_val=.7,a_e,follow,speed=1,new_speed,sfu,sft,sounds=[],w_instr=0,note_q=[],w_note=0,geval=eval,evt_idx,iend,stime;function get_cookies(){var ac=document.cookie.split(";");for(var i=0;i<ac.length;i++){var c=ac[i].split("=");switch(c[0].replace(/ */,"")){case"follow":follow=c[1]=="true";break;case"sft":if(!sft)sft=c[1];break;case"sfu":if(!sfu)sfu=c[1];break;case"volume":vol=Number(c[1]);break}}}function decode_note(instr,mi){function data2bin(dataURI){var i,base64Index=dataURI.indexOf(",")+1,base64=dataURI.substring(base64Index),raw=window.atob(base64),rawl=raw.length,ab=new ArrayBuffer(rawl),array=new Uint8Array(ab);for(i=0;i<rawl;i++)array[i]=raw.charCodeAt(i);return ab}function audio_dcod(instr,mi,snd){ac.decodeAudioData(snd,function(b){sounds[instr][mi]=b;w_note--},function(e){alert("Decode audio data error "+(e?e.err:"???"));w_note--;iend=0;onend()})}w_note++;var p=nn[mi%12]+no[mi/12|0];if(sft=="js"){audio_dcod(instr,mi,data2bin(MIDI.Soundfont[instr_tb[instr]][p]))}else{var url=sfu+"/"+instr_tb[instr]+"-"+sft+"/"+p+"."+sft,req=new XMLHttpRequest;req.open("GET",url);req.responseType="arraybuffer";req.onload=function(){audio_dcod(instr,mi,this.response)};req.onerror=function(msg){if(typeof msg=="object")msg=msg.type;alert("Error '"+msg+"' while loading\n"+url);w_note--;iend=0;onend()};req.send()}}function load_instr(instr){if(sft!="js")return;w_instr++;var url=sfu+"/"+instr_tb[instr]+"-ogg.js",script=document.createElement("script");script.src=url;script.onload=function(){w_instr--};document.head.appendChild(script)}function load_res(){var i,e,instr,mi;for(i=evt_idx;;i++){e=a_e[i];if(!e||e[0]>iend)break;instr=e[2];if(!sounds[instr]){sounds[instr]=[];load_instr(instr)}mi=e[3]|0;if(!sounds[instr][mi]){sounds[instr][mi]=true;note_q.push([instr,mi])}}}function play_next(){var t,e,e2,maxt,o,st,d;e=a_e[evt_idx];if(!e||e[0]>iend){onend();return}if(new_speed){stime=ac.currentTime-(ac.currentTime-stime)*speed/new_speed;speed=new_speed;new_speed=0}t=e[1]/speed;maxt=t+3;while(1){o=ac.createBufferSource();o.buffer=sounds[e[2]][e[3]|0];if(e[5]!=0)o.connect(gain);if(o.detune){d=e[3]*100%100;if(d)o.detune.value=d}d=e[4]/speed;if(loop[e[2]]){o.loop=true;o.loopStart=3;o.loopEnd=10}st=t+stime;o.start(st);o.stop(st+d);if(follow){var i=e[0];st=(st-ac.currentTime)*1e3;setTimeout(onnote,st,i,true);setTimeout(onnote,st+d*1e3,i,false)}e=a_e[++evt_idx];if(!e){setTimeout(onend,(t+stime-ac.currentTime+d)*1e3);return}t=e[1]/speed;if(t>maxt)break}setTimeout(play_next,(t+stime-ac.currentTime)*1e3-300)}function play_start(){if(iend==0)return;if(w_instr!=0){setTimeout(function(){play_start()},300);return}if(note_q.length!=0){while(1){var e=note_q.shift();if(!e)break;decode_note(e[0],e[1])}}if(w_note!=0){setTimeout(function(){play_start()},300);return}stime=ac.currentTime+.2-a_e[evt_idx][1]*speed;play_next()}Audio5.prototype.play=function(istart,i_iend,a_pe){if(a_pe)a_e=a_pe;if(!a_e||!a_e.length){onend();return}iend=i_iend;evt_idx=0;while(a_e[evt_idx]&&a_e[evt_idx][0]<istart)evt_idx++;if(!a_e[evt_idx]){onend();return}load_res();play_start()};Audio5.prototype.stop=function(){iend=0};function set_cookie(n,v){var d=new Date;d.setTime(d.getTime()+31536e6);document.cookie=n+"="+v+";expires="+d.toUTCString()}Audio5.prototype.set_follow=function(v){if(v==undefined)return follow;follow=v;set_cookie("follow",v)};Audio5.prototype.set_sft=function(v){if(v==undefined)return sft;sft=v;set_cookie("sft",v)};Audio5.prototype.get_sft=Audio5.prototype.set_sft;Audio5.prototype.set_sfu=function(v){if(v==undefined)return sfu;sfu=v;set_cookie("sfu",v)};Audio5.prototype.get_sfu=Audio5.prototype.set_sfu;Audio5.prototype.set_speed=function(v){if(v==undefined)return speed;new_speed=v};Audio5.prototype.set_vol=function(v){if(v==undefined){if(gain)return gain.gain.value;return gain_val}if(gain)gain.gain.value=v;else gain_val=v;set_cookie("volume",v.toFixed(2))};Audio5.prototype.get_vol=Audio5.prototype.set_vol;ac=conf.ac;if(!ac){conf.ac=ac=new(window.AudioContext||window.webkitAudioContext);gain=ac.createGain();gain.gain.value=gain_val;gain.connect(ac.destination)}if(conf.sft)sft=conf.sft;if(conf.sfu)sfu=conf.sfu;if(!sfu||!sft)get_cookies();if(!sfu||!sft){if(document.URL.match(/^http:\/\/moinejf.free.fr/)){if(!sfu)sfu="http://moinejf.free.fr/js/FluidR3_GM";if(!sft)sft="ogg"}else{if(!sfu)sfu="https://gleitz.github.io/midi-js-soundfonts/FluidR3_GM";if(!sft)sft="js"}}if(conf.onend)onend=conf.onend;if(conf.onnote)onnote=conf.onnote;if(typeof MIDI=="object")sounds[0]=[];else MIDI={}}
